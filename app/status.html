<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Status</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <aside class="admin-side-menu" id="adminMenu" style="display:none;">
      <h3>Admin Menu</h3>
      <a class="admin-nav-link" id="backAdmin" href="#">Back to Admin Dashboard</a>
      <a class="admin-nav-link" id="viewToggle" href="#" style="display:none;">View as Client</a>
    </aside>

    <main class="page">
      <header class="top">
        <h1 id="title">Project Status</h1>
      </header>

      <section class="panel">
        <h2>Project Details</h2>
        <div class="detail-grid" id="projectDetails"></div>
      </section>

      <article class="panel track" id="sraPanel" style="display:none;">
        <h2>SRA</h2>
        <div class="step-grid" id="sraSteps"></div>
      </article>

      <article class="panel track" id="nvaPanel" style="display:none;">
        <h2>NVA</h2>
        <div class="step-grid" id="nvaSteps"></div>
      </article>

      <section class="panel" id="extraPanel" style="display:none;">
        <h2>Additional Metrics</h2>
        <div class="extra-grid" id="extraMetrics"></div>
      </section>

      <section class="meta" id="meta"></section>
    </main>

    <script>
      const qp = new URLSearchParams(location.search);
      const sfId = qp.get('sf_id') || '';
      const sig = qp.get('sig') || '';
      const key = qp.get('key') || '';
      const mode = (qp.get('mode') || '').toLowerCase();
      const canEdit = mode === 'admin' && !!key;
      let currentDashboard = null;

      function esc(value) {
        return String(value || '').replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
      }

      function iconForLabel(label) {
        if (['ECD', 'ACD', 'Contract Signed'].includes(label)) return '<span class="label-icon icon-calendar" aria-hidden="true"></span>';
        if (label === 'Location') return '<span class="label-icon icon-location" aria-hidden="true"></span>';
        if (['Project Lead', 'Project Support'].includes(label)) return '<span class="label-icon icon-user" aria-hidden="true"></span>';
        if (label === 'Time Zone') return '<span class="label-icon icon-clock" aria-hidden="true"></span>';
        return '';
      }

      function overrideStorageKey() {
        return `ecd_overrides:${sfId}`;
      }

      function loadEcdOverrides() {
        try {
          const raw = localStorage.getItem(overrideStorageKey());
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          return parsed && typeof parsed === 'object' ? parsed : {};
        } catch (_) {
          return {};
        }
      }

      function saveEcdOverrides(overrides) {
        try {
          localStorage.setItem(overrideStorageKey(), JSON.stringify(overrides || {}));
        } catch (_) {}
      }

      function parseUsDate(value) {
        const m = String(value || '').trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (!m) return null;
        const d = new Date(Number(m[3]), Number(m[1]) - 1, Number(m[2]));
        return Number.isNaN(d.getTime()) ? null : d;
      }

      function formatUsDate(d) {
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const yy = d.getFullYear();
        return `${mm}/${dd}/${yy}`;
      }

      function usFromYmd(ymd) {
        const m = String(ymd || '').match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return '';
        return `${m[2]}/${m[3]}/${m[1]}`;
      }

      function ymdFromUs(us) {
        const m = String(us || '').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (!m) return '';
        return `${m[3]}-${m[1]}-${m[2]}`;
      }

      function addDays(d, n) {
        const out = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        out.setDate(out.getDate() + n);
        return out;
      }

      function shiftToMondayIfWeekend(d) {
        const out = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        if (out.getDay() === 6) out.setDate(out.getDate() + 2);
        if (out.getDay() === 0) out.setDate(out.getDate() + 1);
        return out;
      }

      function shiftToFridayIfWeekend(d) {
        const out = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        if (out.getDay() === 6) out.setDate(out.getDate() - 1);
        if (out.getDay() === 0) out.setDate(out.getDate() - 2);
        return out;
      }

      function diffCalendarDays(a, b) {
        const aa = new Date(a.getFullYear(), a.getMonth(), a.getDate());
        const bb = new Date(b.getFullYear(), b.getMonth(), b.getDate());
        return Math.round((aa.getTime() - bb.getTime()) / 86400000);
      }

      function shiftBusinessSafe(d, deltaDays) {
        const shifted = addDays(d, deltaDays);
        return deltaDays < 0 ? shiftToFridayIfWeekend(shifted) : shiftToMondayIfWeekend(shifted);
      }

      function stepStatusClass(status) {
        if (status === 'On Track' || status === 'Completed') return 'status-pill-green';
        if (status === 'Potential Roadblock') return 'status-pill-yellow';
        if (status === 'Roadblock/Overage') return 'status-pill-red';
        return 'status-pill-neutral';
      }

      function computeStepStatus(step) {
        const isKickoff = !!step.isKickoff || String(step.step_slug || '').includes('kickoff');
        const acd = String(step?.acd?.value || '').trim();
        const ecd = String(step?.ecd?.value || '').trim();
        if (acd && acd.toLowerCase() !== 'not set') return isKickoff ? 'Completed' : 'On Track';
        if (isKickoff) return 'Not Started';
        const ecdDate = parseUsDate(ecd);
        if (!ecdDate) return 'Not Started';
        const today = new Date();
        const now = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const due = new Date(ecdDate.getFullYear(), ecdDate.getMonth(), ecdDate.getDate());
        const diff = Math.ceil((due.getTime() - now.getTime()) / 86400000);
        if (diff < 0) return 'Roadblock/Overage';
        if (diff <= 3) return 'Potential Roadblock';
        return 'On Track';
      }

      function recalcStatuses(dashboard) {
        for (const section of ['sra_steps', 'nva_steps']) {
          for (const step of Object.values(dashboard?.[section] || {})) {
            const status = computeStepStatus(step);
            step.status = status;
            step.status_class = stepStatusClass(status);
          }
        }
      }

      function applyEcdValue(step, usDate) {
        const us = String(usDate || '').trim();
        step.ECD = us;
        if (step.ecd) {
          step.ecd.value = us || 'Not set';
          step.ecd.input_value = us ? ymdFromUs(us) : '';
        }
      }

      function collectEcdOverrideChanges(dashboard, metricKey, ymdValue, adjustFollowing) {
        const parts = String(metricKey || '').split('.');
        if (parts.length !== 3 || parts[2] !== 'ecd') return {};
        const sectionKey = parts[0] === 'sra' ? 'sra_steps' : parts[0] === 'nva' ? 'nva_steps' : '';
        if (!sectionKey) return {};

        const entries = Object.entries(dashboard?.[sectionKey] || {});
        const idx = entries.findIndex(([, step]) => String(step?.ecd?.metric_key || '') === metricKey);
        if (idx < 0) return {};

        const target = entries[idx][1];
        const nextUs = usFromYmd(ymdValue);
        const prevUs = String(target?.ecd?.value || '');
        const touched = {};

        applyEcdValue(target, nextUs);
        touched[metricKey] = nextUs;

        const oldDate = parseUsDate(prevUs);
        const newDate = parseUsDate(nextUs);
        if (!adjustFollowing || !oldDate || !newDate) return touched;

        const delta = diffCalendarDays(newDate, oldDate);
        if (!delta) return touched;

        for (let i = idx + 1; i < entries.length; i += 1) {
          const step = entries[i][1];
          const acdDate = parseUsDate(String(step?.acd?.value || ''));
          if (acdDate) continue;

          const currentEcd = parseUsDate(String(step?.ecd?.value || ''));
          if (!currentEcd) continue;

          const shifted = shiftBusinessSafe(currentEcd, delta);
          const shiftedUs = formatUsDate(shifted);
          applyEcdValue(step, shiftedUs);
          const keyForStep = String(step?.ecd?.metric_key || '');
          if (keyForStep) touched[keyForStep] = shiftedUs;
        }
        return touched;
      }

      function applyStoredEcdOverrides(dashboard, overrides) {
        const map = overrides || {};
        for (const section of ['sra_steps', 'nva_steps']) {
          for (const step of Object.values(dashboard?.[section] || {})) {
            const key = String(step?.ecd?.metric_key || '');
            if (!key) continue;
            const saved = String(map[key] || '').trim();
            if (!saved) continue;
            applyEcdValue(step, saved);
          }
        }
        recalcStatuses(dashboard);
      }

      function closeDateEditors() {
        document.querySelectorAll('.date-inline.editing').forEach((node) => node.classList.remove('editing'));
      }

      function closeChoices() {
        document.querySelectorAll('.acd-choice.show').forEach((node) => node.classList.remove('show'));
      }

      function openDateEditor(rowId) {
        closeDateEditors();
        const row = document.getElementById(rowId);
        if (!row) return;
        row.classList.add('editing');
        const input = row.querySelector('input[type="date"]');
        if (input) {
          input.focus();
          if (typeof input.showPicker === 'function') input.showPicker();
        }
      }

      function hideRowEditor(rowId) {
        const row = document.getElementById(rowId);
        if (row) row.classList.remove('editing');
      }

      async function sendUpdate(form, adjustFollowing) {
        const metricKey = form.dataset.metricKey || '';
        const value = form.querySelector('input[type="date"]').value || '';
        if (!metricKey) return;

        const res = await fetch(`/api/update?key=${encodeURIComponent(key)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sf_id: sfId,
            sig,
            metric_key: metricKey,
            value,
            adjust_following: adjustFollowing ? 'yes' : 'no'
          })
        });

        const payload = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(payload.detail || payload.error || `Update failed (${res.status})`);
        }
        return payload;
      }

      async function onDateChange(inputEl) {
        const form = inputEl.closest('form.date-edit');
        const row = inputEl.closest('.date-inline');
        const choice = form ? form.querySelector('.acd-choice') : null;
        if (!form || !row) return;

        const isAcd = (form.dataset.dateType || '').toLowerCase() === 'acd';
        const isEcd = (form.dataset.dateType || '').toLowerCase() === 'ecd';
        if (isAcd && choice) {
          choice.classList.add('show');
          return;
        }

        try {
          let adjust = true;
          if (isEcd) {
            adjust = window.confirm('Adjust following ECD dates based on this change?');
          }
          const payload = await sendUpdate(form, adjust);
          if (isEcd && payload && payload.local_only && currentDashboard) {
            const draft = JSON.parse(JSON.stringify(currentDashboard));
            const touched = collectEcdOverrideChanges(draft, form.dataset.metricKey || '', inputEl.value || '', adjust);
            const overrides = loadEcdOverrides();
            for (const [k, v] of Object.entries(touched)) {
              if (String(v || '').trim()) overrides[k] = v;
              else delete overrides[k];
            }
            saveEcdOverrides(overrides);
          }
          location.reload();
        } catch (err) {
          alert(err.message || 'Unable to save date.');
          hideRowEditor(row.id);
        }
      }

      async function submitAcdChoice(buttonEl, adjustFollowing) {
        const form = buttonEl.closest('form.date-edit');
        const row = form ? form.querySelector('.date-inline') : null;
        if (!form || !row) return;
        try {
          await sendUpdate(form, adjustFollowing);
          location.reload();
        } catch (err) {
          alert(err.message || 'Unable to save date.');
          hideRowEditor(row.id);
          closeChoices();
        }
      }

      function onDateKeydown(evt, rowId) {
        if (evt.key === 'Escape') {
          evt.preventDefault();
          hideRowEditor(rowId);
          closeChoices();
        }
      }

      function makeDateField(section, idx, type, field) {
        const id = `${section}-${idx}-${type}`;
        const metricKey = field.metric_key || '';
        const valueLabel = field.value || 'Not set';
        const inputValue = field.input_value || '';
        const editable = !!field.editable && canEdit;

        if (!editable) {
          return `<p><span class="label">${type.toUpperCase()}:</span> <span class="value">${esc(valueLabel)}</span></p>`;
        }

        const acdChoice = type === 'acd'
          ? `<div class="acd-choice">
              <span class="acd-choice-label">Apply this date to following timeline?</span>
              <button type="button" onclick="submitAcdChoice(this, true)">Adjust following ECDs</button>
              <button type="button" class="ghost" onclick="submitAcdChoice(this, false)">Keep following ECDs</button>
            </div>`
          : '';

        return `<form class="date-edit" data-metric-key="${esc(metricKey)}" data-date-type="${type}">
          <span class="label">${type.toUpperCase()}:</span>
          <div class="date-inline" id="${id}">
            <span class="date-value-btn" onclick="openDateEditor('${id}')">${esc(valueLabel)}</span>
            <span class="date-editor">
              <input type="date" value="${esc(inputValue)}" onchange="onDateChange(this)" onkeydown="onDateKeydown(event, '${id}')" />
            </span>
          </div>
          ${acdChoice}
        </form>`;
      }

      function renderStep(section, name, step, idx) {
        const extras = (step.extras || [])
          .map((x) => `<p><span class="label">${esc(x.label)}:</span> <span class="value">${esc(x.value || 'Not set')}</span></p>`)
          .join('');

        return `<section class="step-card">
          <h3>${esc(name)}</h3>
          <div class="step-fields">
            <div class="step-row two-col">
              <p><span class="label">Status:</span> <span class="value status-pill ${esc(step.status_class || 'status-pill-neutral')}">${esc(step.status || 'Not set')}</span></p>
              <p><span class="label">Owner:</span> <span class="value">${esc(step.owner || step.Owner || 'Not assigned')}</span></p>
            </div>
            <div class="step-row two-col">
              ${makeDateField(section, idx, 'ecd', step.ecd || {})}
              ${makeDateField(section, idx, 'acd', step.acd || {})}
            </div>
            ${extras}
          </div>
        </section>`;
      }

      async function loadPage() {
        if (!sfId || !sig) {
          document.body.innerHTML = '<main class="page"><section class="panel"><h2>Missing sf_id or sig.</h2></section></main>';
          return;
        }

        const res = await fetch(`/api/status?sf_id=${encodeURIComponent(sfId)}&sig=${encodeURIComponent(sig)}`);
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          document.body.innerHTML = `<main class="page"><section class="panel"><h2>Load failed</h2><p>${esc(data.detail || data.error || res.status)}</p></section></main>`;
          return;
        }

        if (mode === 'admin') {
          document.getElementById('adminMenu').style.display = '';
          document.getElementById('backAdmin').href = `/admin/projects?key=${encodeURIComponent(key)}`;
          if (canEdit) {
            const vt = document.getElementById('viewToggle');
            vt.style.display = '';
            vt.href = `/status?sf_id=${encodeURIComponent(sfId)}&sig=${encodeURIComponent(sig)}`;
          }
        }

        document.getElementById('title').textContent = data.task_name || 'Project Status';

        const dashboard = data.dashboard || {};
        currentDashboard = dashboard;
        applyStoredEcdOverrides(dashboard, loadEcdOverrides());
        const details = dashboard.project_details || {};
        document.getElementById('projectDetails').innerHTML = Object.entries(details)
          .map(([label, value]) => `<article class="detail-item"><p class="label">${iconForLabel(label)}${esc(label)}</p><p class="value">${esc(value || 'Not set')}</p></article>`)
          .join('');

        const sra = dashboard.sra_steps || {};
        if (dashboard.show_sra && Object.keys(sra).length) {
          document.getElementById('sraPanel').style.display = '';
          document.getElementById('sraSteps').innerHTML = Object.entries(sra).map(([name, step], idx) => renderStep('sra', name, step, idx)).join('');
        }

        const nva = dashboard.nva_steps || {};
        if (dashboard.show_nva && Object.keys(nva).length) {
          document.getElementById('nvaPanel').style.display = '';
          document.getElementById('nvaSteps').innerHTML = Object.entries(nva).map(([name, step], idx) => renderStep('nva', name, step, idx)).join('');
        }

        const extra = dashboard.extra_metrics || {};
        if (Object.keys(extra).length) {
          document.getElementById('extraPanel').style.display = '';
          document.getElementById('extraMetrics').innerHTML = Object.entries(extra)
            .map(([label, value]) => `<article class="extra-item"><p class="label">${esc(label)}</p><p class="value">${esc(value || 'Not set')}</p></article>`)
            .join('');
        }

        const taskUrl = data.task_url ? `<p><a href="${esc(data.task_url)}" target="_blank" rel="noreferrer">Open task in ClickUp</a></p>` : '';
        document.getElementById('meta').innerHTML = `
          <p>SF ID: ${esc(data.sf_id)}</p>
          <p>Last updated in ClickUp: ${esc(data.source_updated_at || 'Unknown')}</p>
          <p>Last synced to dashboard: ${esc(data.synced_at || 'Unknown')}</p>
          ${taskUrl}
        `;
      }

      document.addEventListener('click', (evt) => {
        const insideDate = evt.target.closest('.date-inline');
        const insideChoice = evt.target.closest('.acd-choice');
        const insideBtn = evt.target.closest('.date-value-btn');
        if (!insideDate && !insideChoice && !insideBtn) {
          closeDateEditors();
          closeChoices();
        }
      });

      loadPage().catch((err) => {
        document.body.innerHTML = `<main class="page"><section class="panel"><h2>Load failed</h2><p>${esc(err.message || err)}</p></section></main>`;
      });
    </script>
  </body>
</html>
