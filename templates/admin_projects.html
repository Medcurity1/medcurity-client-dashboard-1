<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <aside class="admin-side-menu">
      <h3>Admin Menu</h3>
      <a class="admin-nav-link" href="{{ projects_url }}">Projects</a>
      <a class="admin-nav-link" href="{{ metrics_url }}">Metrics</a>
    </aside>
    <main class="page">
      <header class="top">
        <h1>Admin Dashboard</h1>
        <p>{{ count }} clients</p>
      </header>

      <section class="panel">
        <div class="admin-controls">
          <input id="projectSearch" class="project-search" type="search" placeholder="Search by client name or SF ID..." oninput="filterProjects()" />
          <div class="status-multiselect" id="statusFilterControl">
            <button
              type="button"
              id="statusFilterToggle"
              class="project-filter status-toggle"
              onclick="toggleStatusFilterPanel()"
            >
              All statuses
            </button>
            <div id="statusFilterPanel" class="status-filter-panel" hidden>
              <div id="statusFilter" class="status-filter-list">
                {% for status_name in all_statuses %}
                  <label class="status-filter-option">
                    <input type="checkbox" value="{{ status_name|lower }}" onchange="onStatusSelectionChange()" />
                    <span>{{ status_name }}</span>
                  </label>
                {% endfor %}
              </div>
              <div class="status-filter-actions">
                <button type="button" class="status-action-btn" onclick="clearStatusSelection()">Clear</button>
                <button type="button" class="status-action-btn primary" onclick="closeStatusFilterPanel()">Done</button>
              </div>
            </div>
          </div>
          <div class="status-multiselect" id="leadFilterControl">
            <button
              type="button"
              id="leadFilterToggle"
              class="project-filter status-toggle"
              onclick="toggleLeadFilterPanel()"
            >
              All project leads
            </button>
            <div id="leadFilterPanel" class="status-filter-panel" hidden>
              <div id="leadFilter" class="status-filter-list">
                {% for lead_name in all_project_leads %}
                  <label class="status-filter-option">
                    <input type="checkbox" value="{{ lead_name|lower }}" onchange="onLeadSelectionChange()" />
                    <span>{{ lead_name }}</span>
                  </label>
                {% endfor %}
              </div>
              <div class="status-filter-actions">
                <button type="button" class="status-action-btn" onclick="clearLeadSelection()">Clear</button>
                <button type="button" class="status-action-btn primary" onclick="closeLeadFilterPanel()">Done</button>
              </div>
            </div>
          </div>
          <a class="project-filter refresh-link" href="/admin/projects?key={{ request.args.get('key', '') }}&refresh=1">Refresh From ClickUp</a>
        </div>
      </section>

      <section class="panel">
        <h2>Active Projects ({{ active_count }})</h2>
        <p class="admin-summary">
          {% for status_name, status_count in active_status_counts.items() %}
            <span class="summary-pill">{{ status_name }}: {{ status_count }}</span>
          {% endfor %}
        </p>
        {% if active_groups %}
          {% for period, projects in active_groups.items() %}
            <h3 class="admin-period">{{ period }}</h3>
            <table class="admin-table projectsTable">
              <thead>
                <tr>
                  <th>Client</th>
                  <th>SF ID</th>
                  <th>Project Lead</th>
                  <th>Status</th>
                  <th>Start Date</th>
                  <th>Completed Date</th>
                </tr>
              </thead>
              <tbody>
                {% for project in projects %}
                  <tr data-status="{{ project.task_status|lower }}" data-project-lead="{{ project.project_lead|lower }}" data-section="active">
                    <td><a href="{{ project.status_url }}">{{ project.task_name }}</a></td>
                    <td>{{ project.sf_id }}</td>
                    <td>{{ project.project_lead }}</td>
                    <td>{{ project.task_status }}</td>
                    <td>{{ project.start_date_label }}</td>
                    <td>{{ project.completed_date_label }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endfor %}
        {% else %}
          <p class="admin-empty">No active projects.</p>
        {% endif %}
      </section>

      <section class="panel">
        <h2>Completed Projects ({{ completed_count }})</h2>
        <p class="admin-summary">
          {% for status_name, status_count in completed_status_counts.items() %}
            <span class="summary-pill">{{ status_name }}: {{ status_count }}</span>
          {% endfor %}
        </p>
        {% if completed_groups %}
          {% for period, projects in completed_groups.items() %}
            <h3 class="admin-period">{{ period }}</h3>
            <table class="admin-table projectsTable">
              <thead>
                <tr>
                  <th>Client</th>
                  <th>SF ID</th>
                  <th>Project Lead</th>
                  <th>Status</th>
                  <th>Start Date</th>
                  <th>Completed Date</th>
                </tr>
              </thead>
              <tbody>
                {% for project in projects %}
                  <tr data-status="{{ project.task_status|lower }}" data-project-lead="{{ project.project_lead|lower }}" data-section="completed">
                    <td><a href="{{ project.status_url }}">{{ project.task_name }}</a></td>
                    <td>{{ project.sf_id }}</td>
                    <td>{{ project.project_lead }}</td>
                    <td>{{ project.task_status }}</td>
                    <td>{{ project.start_date_label }}</td>
                    <td>{{ project.completed_date_label }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endfor %}
        {% else %}
          <p class="admin-empty">No completed projects.</p>
        {% endif %}
      </section>
    </main>
    <script>
      var ADMIN_FILTERS_KEY = "medcurity_admin_filters_v1";

      function saveAdminFilters() {
        var searchValue = (document.getElementById("projectSearch") || {}).value || "";
        var selectedStatuses = selectedStatusValues();
        var selectedLeads = selectedLeadValues();
        var state = {
          search: searchValue,
          statuses: selectedStatuses,
          leads: selectedLeads,
        };
        try {
          window.localStorage.setItem(ADMIN_FILTERS_KEY, JSON.stringify(state));
        } catch (error) {}
      }

      function loadAdminFilters() {
        var raw = "";
        try {
          raw = window.localStorage.getItem(ADMIN_FILTERS_KEY) || "";
        } catch (error) {}
        if (!raw) return;

        var parsed = null;
        try {
          parsed = JSON.parse(raw);
        } catch (error) {
          return;
        }
        if (!parsed || typeof parsed !== "object") return;

        var searchInput = document.getElementById("projectSearch");
        if (searchInput && typeof parsed.search === "string") {
          searchInput.value = parsed.search;
        }

        var statusSet = new Set(Array.isArray(parsed.statuses) ? parsed.statuses : []);
        document.querySelectorAll("#statusFilter input[type='checkbox']").forEach(function (box) {
          box.checked = statusSet.has((box.value || "").toLowerCase());
        });

        var leadSet = new Set(Array.isArray(parsed.leads) ? parsed.leads : []);
        document.querySelectorAll("#leadFilter input[type='checkbox']").forEach(function (box) {
          box.checked = leadSet.has((box.value || "").toLowerCase());
        });
      }

      function filterProjects() {
        var input = document.getElementById("projectSearch");
        var filter = (input.value || "").toLowerCase();
        var selectedStatuses = Array.from(
          document.querySelectorAll("#statusFilter input[type='checkbox']:checked")
        ).map(function (box) {
          return (box.value || "").toLowerCase();
        });
        var selectedLeads = Array.from(
          document.querySelectorAll("#leadFilter input[type='checkbox']:checked")
        ).map(function (box) {
          return (box.value || "").toLowerCase();
        });
        var rows = document.querySelectorAll(".projectsTable tbody tr");
        var activeVisible = 0;
        var completedVisible = 0;
        rows.forEach(function (row) {
          var text = (row.textContent || "").toLowerCase();
          var rowStatus = (row.getAttribute("data-status") || "").toLowerCase();
          var rowLead = (row.getAttribute("data-project-lead") || "").toLowerCase();
          var matchesText = text.indexOf(filter) >= 0;
          var matchesStatus = selectedStatuses.length === 0 || selectedStatuses.indexOf(rowStatus) >= 0;
          var matchesLead = selectedLeads.length === 0 || selectedLeads.indexOf(rowLead) >= 0;
          var visible = matchesText && matchesStatus && matchesLead;
          row.style.display = visible ? "" : "none";
          if (visible) {
            if (row.getAttribute("data-section") === "active") {
              activeVisible += 1;
            } else if (row.getAttribute("data-section") === "completed") {
              completedVisible += 1;
            }
          }
        });
        var h2s = document.querySelectorAll("h2");
        h2s.forEach(function (h2) {
          if (h2.textContent.indexOf("Active Projects") === 0) {
            h2.textContent = "Active Projects (" + activeVisible + ")";
          } else if (h2.textContent.indexOf("Completed Projects") === 0) {
            h2.textContent = "Completed Projects (" + completedVisible + ")";
          }
        });
        saveAdminFilters();
      }

      function selectedStatusValues() {
        return Array.from(document.querySelectorAll("#statusFilter input[type='checkbox']:checked")).map(function (
          box
        ) {
          return (box.value || "").toLowerCase();
        });
      }

      function updateStatusFilterLabel() {
        var toggle = document.getElementById("statusFilterToggle");
        var selected = selectedStatusValues();
        if (!toggle) return;
        toggle.textContent = selected.length === 0 ? "All statuses" : selected.length + " selected";
      }

      function onStatusSelectionChange() {
        updateStatusFilterLabel();
        filterProjects();
      }

      function clearStatusSelection() {
        document.querySelectorAll("#statusFilter input[type='checkbox']").forEach(function (box) {
          box.checked = false;
        });
        onStatusSelectionChange();
      }

      function toggleStatusFilterPanel() {
        var panel = document.getElementById("statusFilterPanel");
        if (!panel) return;
        panel.hidden = !panel.hidden;
      }

      function closeStatusFilterPanel() {
        var panel = document.getElementById("statusFilterPanel");
        if (!panel) return;
        panel.hidden = true;
      }

      function selectedLeadValues() {
        return Array.from(document.querySelectorAll("#leadFilter input[type='checkbox']:checked")).map(function (
          box
        ) {
          return (box.value || "").toLowerCase();
        });
      }

      function updateLeadFilterLabel() {
        var toggle = document.getElementById("leadFilterToggle");
        var selected = selectedLeadValues();
        if (!toggle) return;
        toggle.textContent = selected.length === 0 ? "All project leads" : selected.length + " selected";
      }

      function onLeadSelectionChange() {
        updateLeadFilterLabel();
        filterProjects();
      }

      function clearLeadSelection() {
        document.querySelectorAll("#leadFilter input[type='checkbox']").forEach(function (box) {
          box.checked = false;
        });
        onLeadSelectionChange();
      }

      function toggleLeadFilterPanel() {
        var panel = document.getElementById("leadFilterPanel");
        if (!panel) return;
        panel.hidden = !panel.hidden;
      }

      function closeLeadFilterPanel() {
        var panel = document.getElementById("leadFilterPanel");
        if (!panel) return;
        panel.hidden = true;
      }

      document.addEventListener("DOMContentLoaded", function () {
        document.addEventListener("click", function (event) {
          var control = document.getElementById("statusFilterControl");
          if (control && !control.contains(event.target)) {
            closeStatusFilterPanel();
          }
          var leadControl = document.getElementById("leadFilterControl");
          if (leadControl && !leadControl.contains(event.target)) {
            closeLeadFilterPanel();
          }
        });
        loadAdminFilters();
        updateStatusFilterLabel();
        updateLeadFilterLabel();
        filterProjects();
      });
    </script>
  </body>
</html>
