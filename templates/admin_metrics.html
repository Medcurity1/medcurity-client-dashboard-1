<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Metrics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <aside class="admin-side-menu">
      <h3>Admin Menu</h3>
      <a class="admin-nav-link" href="{{ projects_url }}">Projects</a>
      <a class="admin-nav-link" href="{{ metrics_url }}">Metrics</a>
    </aside>

    <main class="page">
      <header class="top">
        <h1>Admin Metrics</h1>
        <p>{{ total_rows }} closed track records</p>
      </header>

      <section class="panel">
        <div class="admin-controls">
          <input id="metricSearch" class="project-search" type="search" placeholder="Search by company..." oninput="filterMetricRows()" />

          <div class="status-multiselect" id="quarterFilterControl">
            <button type="button" id="quarterFilterToggle" class="project-filter status-toggle" onclick="togglePanel('quarterFilterPanel')">
              All quarters
            </button>
            <div id="quarterFilterPanel" class="status-filter-panel" hidden>
              <div id="quarterFilter" class="status-filter-list">
                {% for quarter in all_quarters %}
                  <label class="status-filter-option">
                    <input type="checkbox" value="{{ quarter|lower }}" onchange="onMetricFilterChange()" />
                    <span>{{ quarter }}</span>
                  </label>
                {% endfor %}
              </div>
              <div class="status-filter-actions">
                <button type="button" class="status-action-btn" onclick="clearFilterGroup('quarterFilter')">Clear</button>
                <button type="button" class="status-action-btn primary" onclick="closePanel('quarterFilterPanel')">Done</button>
              </div>
            </div>
          </div>

          <div class="status-multiselect" id="trackFilterControl">
            <button type="button" id="trackFilterToggle" class="project-filter status-toggle" onclick="togglePanel('trackFilterPanel')">
              All tracks
            </button>
            <div id="trackFilterPanel" class="status-filter-panel" hidden>
              <div id="trackFilter" class="status-filter-list">
                {% for track in all_tracks %}
                  <label class="status-filter-option">
                    <input type="checkbox" value="{{ track|lower }}" onchange="onMetricFilterChange()" />
                    <span>{{ track }}</span>
                  </label>
                {% endfor %}
              </div>
              <div class="status-filter-actions">
                <button type="button" class="status-action-btn" onclick="clearFilterGroup('trackFilter')">Clear</button>
                <button type="button" class="status-action-btn primary" onclick="closePanel('trackFilterPanel')">Done</button>
              </div>
            </div>
          </div>

          <div class="status-multiselect" id="sourceFilterControl">
            <button type="button" id="sourceFilterToggle" class="project-filter status-toggle" onclick="togglePanel('sourceFilterPanel')">
              All sources
            </button>
            <div id="sourceFilterPanel" class="status-filter-panel" hidden>
              <div id="sourceFilter" class="status-filter-list">
                {% for source in all_sources %}
                  <label class="status-filter-option">
                    <input type="checkbox" value="{{ source|lower }}" onchange="onMetricFilterChange()" />
                    <span>{{ source }}</span>
                  </label>
                {% endfor %}
              </div>
              <div class="status-filter-actions">
                <button type="button" class="status-action-btn" onclick="clearFilterGroup('sourceFilter')">Clear</button>
                <button type="button" class="status-action-btn primary" onclick="closePanel('sourceFilterPanel')">Done</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="panel">
        <h2>Core Metrics</h2>
        <p class="admin-summary">
          <span class="summary-pill">Overall Avg Close Days: {{ summary.overall_avg_days if summary.overall_avg_days is not none else 'N/A' }}</span>
          <span class="summary-pill">Tracked Avg Close Days (<= {{ summary.tracked_max_days }}): {{ summary.tracked_avg_days if summary.tracked_avg_days is not none else 'N/A' }} ({{ summary.tracked_count }})</span>
          <span class="summary-pill">Outlier Count (> {{ summary.tracked_max_days }}): {{ summary.untracked_outlier_count }}</span>
          <span class="summary-pill">Median Days: {{ summary.overall_median_days if summary.overall_median_days is not none else 'N/A' }}</span>
          <span class="summary-pill">P90 Days: {{ summary.overall_p90_days if summary.overall_p90_days is not none else 'N/A' }}</span>
          <span class="summary-pill">SRA Avg: {{ summary.overall_sra_avg_days if summary.overall_sra_avg_days is not none else 'N/A' }} ({{ summary.overall_sra_count }})</span>
          <span class="summary-pill">NVA Avg: {{ summary.overall_nva_avg_days if summary.overall_nva_avg_days is not none else 'N/A' }} ({{ summary.overall_nva_count }})</span>
          <span class="summary-pill">Historical Rows: {{ historical_count }}</span>
          <span class="summary-pill">Historical Range: {{ historical_range }}</span>
          <span class="summary-pill">Live Rows: {{ live_count }}</span>
        </p>
      </section>

      <section class="panel">
        <h2>Data Quality</h2>
        <p class="admin-summary">
          <span class="summary-pill">ClickUp Completed Projects: {{ live_quality.completed_task_total }}</span>
          <span class="summary-pill">Completed With Valid Close Dates: {{ live_quality.completed_task_with_valid_close }}</span>
          <span class="summary-pill">Coverage: {{ coverage_pct if coverage_pct is not none else 'N/A' }}%</span>
          <span class="summary-pill">Missing Date Projects (ClickUp): {{ live_quality.completed_task_missing_close_dates }}</span>
          <span class="summary-pill">Missing Covered By Historical: {{ live_quality.missing_covered_by_historical }}</span>
          <span class="summary-pill">Missing Uncovered: {{ live_quality.missing_uncovered }}</span>
          <span class="summary-pill">Missing SRA Date Rows: {{ live_quality.missing_sra_dates }}</span>
          <span class="summary-pill">Missing NVA Date Rows: {{ live_quality.missing_nva_dates }}</span>
        </p>
      </section>

      <section class="panel">
        <h2>Average Close Days By Quarter</h2>
        {% if quarter_rows %}
          <table class="admin-table">
            <thead>
              <tr>
                <th>Quarter</th>
                <th>Projects</th>
                <th>Avg Close Days</th>
                <th>SRA Avg</th>
                <th>NVA Avg</th>
              </tr>
            </thead>
            <tbody>
              {% for row in quarter_rows %}
                <tr>
                  <td>{{ row.quarter_label }}</td>
                  <td>{{ row.project_count }}</td>
                  <td>{{ row.avg_close_days }}</td>
                  <td>{{ row.avg_sra_days if row.avg_sra_days is not none else 'N/A' }}</td>
                  <td>{{ row.avg_nva_days if row.avg_nva_days is not none else 'N/A' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="admin-empty">No closed records available.</p>
        {% endif %}
      </section>

      <section class="panel">
        <h2>Closed Record Details</h2>
        {% if metric_rows %}
          <table class="admin-table" id="metricsTable">
            <thead>
              <tr>
                <th>Company</th>
                <th>Track</th>
                <th>Quarter</th>
                <th>Close Days</th>
                <th>Source</th>
                <th>Kickoff</th>
                <th>Final</th>
              </tr>
            </thead>
            <tbody>
              {% for row in metric_rows %}
                <tr data-track="{{ row.track|lower }}" data-quarter="{{ row.quarter_label|lower }}" data-source="{{ row.source|lower }}">
                  <td>{{ row.company }}</td>
                  <td>{{ row.track }}</td>
                  <td>{{ row.quarter_label }}</td>
                  <td>{{ row.close_days }}</td>
                  <td>{{ row.source }}</td>
                  <td>{{ row.kickoff_date }}</td>
                  <td>{{ row.final_date }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="admin-empty">No closed records available.</p>
        {% endif %}
      </section>
    </main>

    <script>
      var METRICS_FILTERS_KEY = "medcurity_metrics_filters_v1";

      function selectedValues(groupId) {
        return Array.from(document.querySelectorAll("#" + groupId + " input[type='checkbox']:checked")).map(function (box) {
          return (box.value || "").toLowerCase();
        });
      }

      function updateToggleLabel(toggleId, values, emptyLabel) {
        var el = document.getElementById(toggleId);
        if (!el) return;
        el.textContent = values.length === 0 ? emptyLabel : values.length + " selected";
      }

      function saveMetricFilters() {
        var state = {
          search: (document.getElementById("metricSearch") || {}).value || "",
          quarters: selectedValues("quarterFilter"),
          tracks: selectedValues("trackFilter"),
          sources: selectedValues("sourceFilter"),
        };
        try {
          window.localStorage.setItem(METRICS_FILTERS_KEY, JSON.stringify(state));
        } catch (error) {}
      }

      function loadMetricFilters() {
        var raw = "";
        try {
          raw = window.localStorage.getItem(METRICS_FILTERS_KEY) || "";
        } catch (error) {}
        if (!raw) return;
        var state = null;
        try {
          state = JSON.parse(raw);
        } catch (error) {
          return;
        }
        if (!state || typeof state !== "object") return;

        var search = document.getElementById("metricSearch");
        if (search && typeof state.search === "string") {
          search.value = state.search;
        }

        var quarters = new Set(Array.isArray(state.quarters) ? state.quarters : []);
        document.querySelectorAll("#quarterFilter input[type='checkbox']").forEach(function (box) {
          box.checked = quarters.has((box.value || "").toLowerCase());
        });

        var tracks = new Set(Array.isArray(state.tracks) ? state.tracks : []);
        document.querySelectorAll("#trackFilter input[type='checkbox']").forEach(function (box) {
          box.checked = tracks.has((box.value || "").toLowerCase());
        });

        var sources = new Set(Array.isArray(state.sources) ? state.sources : []);
        document.querySelectorAll("#sourceFilter input[type='checkbox']").forEach(function (box) {
          box.checked = sources.has((box.value || "").toLowerCase());
        });
      }

      function filterMetricRows() {
        var query = ((document.getElementById("metricSearch") || {}).value || "").toLowerCase();
        var quarters = selectedValues("quarterFilter");
        var tracks = selectedValues("trackFilter");
        var sources = selectedValues("sourceFilter");

        var rows = document.querySelectorAll("#metricsTable tbody tr");
        rows.forEach(function (row) {
          var text = (row.textContent || "").toLowerCase();
          var rowQuarter = (row.getAttribute("data-quarter") || "").toLowerCase();
          var rowTrack = (row.getAttribute("data-track") || "").toLowerCase();
          var rowSource = (row.getAttribute("data-source") || "").toLowerCase();

          var matchesText = text.indexOf(query) >= 0;
          var matchesQuarter = quarters.length === 0 || quarters.indexOf(rowQuarter) >= 0;
          var matchesTrack = tracks.length === 0 || tracks.indexOf(rowTrack) >= 0;
          var matchesSource = sources.length === 0 || sources.indexOf(rowSource) >= 0;
          row.style.display = matchesText && matchesQuarter && matchesTrack && matchesSource ? "" : "none";
        });

        updateToggleLabel("quarterFilterToggle", quarters, "All quarters");
        updateToggleLabel("trackFilterToggle", tracks, "All tracks");
        updateToggleLabel("sourceFilterToggle", sources, "All sources");
        saveMetricFilters();
      }

      function onMetricFilterChange() {
        filterMetricRows();
      }

      function clearFilterGroup(groupId) {
        document.querySelectorAll("#" + groupId + " input[type='checkbox']").forEach(function (box) {
          box.checked = false;
        });
        filterMetricRows();
      }

      function togglePanel(panelId) {
        var panel = document.getElementById(panelId);
        if (!panel) return;
        panel.hidden = !panel.hidden;
      }

      function closePanel(panelId) {
        var panel = document.getElementById(panelId);
        if (!panel) return;
        panel.hidden = true;
      }

      document.addEventListener("DOMContentLoaded", function () {
        loadMetricFilters();
        filterMetricRows();

        document.addEventListener("click", function (event) {
          ["quarterFilterControl", "trackFilterControl", "sourceFilterControl"].forEach(function (controlId) {
            var control = document.getElementById(controlId);
            if (!control || control.contains(event.target)) return;
            var panel = control.querySelector(".status-filter-panel");
            if (panel) panel.hidden = true;
          });
        });
      });
    </script>
  </body>
</html>
